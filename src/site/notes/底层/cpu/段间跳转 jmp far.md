---
{"dg-publish":true,"permalink":"/底层/cpu/段间跳转 jmp far/","noteIcon":"1","created":"","updated":""}
---

在段之间跳转，也就是跨段跳转，本质上就是修改 `CS:IP`，任意时刻，由 `CS:IP` 所构成的地址就是 CPU 所正在执行的指令。因此不存在只修改 `CS` 的指令，因为修改 CS 仅仅修改了一半的地址。
要跳转必须同时修改 `CS:IP`，同时修改 CS 与 EIP 的指令：
`JMP FAR / CALL FAR / RETF / INT /IRETED`

只改变 EIP 的指令：
`JMP / CALL / JCC / RET`

跨段跳转分为两种：
1. 一致代码段 （段描述符 Type 域的 C 位，C=1）
2. 非一致代码段 （C=0）

### JMP FAR
远跳转指令后面跟 6 个字节
`JMP 0x0020:0x004183D7` CPU 如何执行这行代码?
1. 拆分高 2 字节的段选择子：`0x20=0010 0000`：RPL=0，TI=0，Index=4，去 GDT 表查第 5 个。
2. 找到段描述符后，检查是否可以跳转。只有**代码段、调用门、TSS 任务段、任务门**可以跳转。
3. 确认可以跳转后，检查权限：
	- 如果是非一致代码段，要求：CPL == DPL 并且 RPL <= DPL  当前权限**等于**段描述符表的权限，或者请求权限**不低于**段描述符表的权限。
	- 如果是一致代码段，要求：CPL >= DPL，当前权限比段描述符表的权限**低**
4. 加载段描述符，通过权限检查后，CPU 将段描述符加载到 CS 段寄存器中。
5. 代码执行，CPU 将 `CS.Base + Offset` 写入到 EIP，然后执行。



对于一致代码段：也就是共享的段
- 特权级高的程序不允许访问特权级低的数据：核心态不允许访问用户态的数据
- 特权级低的程序可以访问到特权级高的数据，但特权级不会改变：用户态还是用户态

对于普通代码段：也就是非一致代码段
- 只允许同级访问
- 绝对禁止不同级别的访问：核心态不是用户态，用户态也不是核心态。


接对代码段进行 JMP 或者 CALL 的操作，无论目标是一致代码段还是非一致代码段，CPL 都不会发生改变，如果要提升 CPL 的权限，只能通过调用门。
